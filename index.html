<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Paranoids Labyrinth</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            background-color: #000;
            color: #00ffff;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            text-align: center;
        }
        
        .game-wrapper {
            display: flex;
            flex-direction: column;
            height: 98vh; /* Use vh to ensure full height on mobile */
            width: 98vw;
            max-width: 600px;
        }

        #game-container {
            position: relative;
            flex: 1; /* Takes up 50% of the available vertical space */
            background: #000;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px #00ffff, 0 0 10px #00ffff inset;
            border-radius: 10px;
            overflow: hidden;
            transition: box-shadow 0.5s ease-in-out, border-color 0.5s ease-in-out;
            margin-bottom: 5px; /* Add some space between game and controls */
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .info-panel {
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            text-shadow: 0 0 5px #00ffff;
            width: 100%;
            padding: 0 5px;
        }

        #health-bar-container {
            width: 150px;
            height: 20px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            box-shadow: 0 0 5px #00ff00;
        }

        #health-bar {
            height: 100%;
            background-color: #00ff00;
            transition: width 0.3s ease-in-out;
        }
        
        .pause-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            color: #000;
            background-color: #ff00ff;
            border: 2px solid #ff00ff;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px #ff00ff;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .pause-button:hover {
            transform: scale(1.05);
        }
        .pause-button:active {
            transform: scale(1);
        }

        #message-box, #options-menu {
            display: none;
        }
        
        #start-menu, #message-box, #options-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff00ff;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 0 15px #ff00ff;
            z-index: 100;
            width: 80%;
            max-width: 400px;
        }

        #message-box h2, #start-menu h2, #options-menu h2 {
            margin: 0 0 10px;
            color: #ff00ff;
        }

        #message-box p, #start-menu p, #options-menu p {
            margin: 0 0 20px;
            font-size: 1.1em;
        }
        
        .game-button {
            padding: 10px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            color: #000;
            background-color: #00ffff;
            border: 2px solid #00ffff;
            border-radius: 8px;
            cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 10px #00ffff;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .game-button:hover {
            transform: scale(1.05);
            background-color: #33ffff;
            box-shadow: 0 0 20px #00ffff;
        }
        
        .game-button:active {
            transform: scale(1);
            box-shadow: 0 0 5px #00ffff;
        }
        
        .game-controls-container {
            flex: 1; /* Takes up the remaining 50% of vertical space */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-top: 5px;
            width: 100%;
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 150px;
            height: 150px;
            background: #333;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ffff;
        }
        
        .d-pad-btn {
            background: #555;
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .d-pad-btn:hover {
            background: #888;
            box-shadow: 0 0 5px #00ffff;
        }
        
        .d-pad-btn:active {
            background: #bbb;
            transform: scale(0.95);
        }

        .d-pad-btn.up { grid-area: 1 / 2 / 2 / 3; border-radius: 10px 10px 0 0; }
        .d-pad-btn.left { grid-area: 2 / 1 / 3 / 2; border-radius: 10px 0 0 10px; }
        .d-pad-btn.right { grid-area: 2 / 3 / 3 / 4; border-radius: 0 10px 10px 0; }
        .d-pad-btn.down { grid-area: 3 / 2 / 4 / 3; border-radius: 0 0 10px 10px; }
        .d-pad-center { grid-area: 2 / 2 / 3 / 3; background: #333; }

        .action-buttons {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 150px;
            height: 150px;
            margin-left: 50px;
        }

        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #ff00ff;
            background-color: #cc00cc;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 0 10px #ff00ff;
            transition: all 0.2s ease;
        }
        
        .action-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 5px #ff00ff;
        }
        
        .action-btn.fire {
            background-color: #ff0000;
            border-color: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }
        
        .action-btn.turret {
            background-color: #00ff00;
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .instructions {
            margin-top: 15px;
            font-size: 0.9em;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <button class="pause-button" id="pause-button" style="display: none;">Pause</button>
        </div>

        <div class="game-controls-container">
            <div class="d-pad">
                <button id="up-btn" class="d-pad-btn up" data-direction="up">▲</button>
                <button id="left-btn" class="d-pad-btn left" data-direction="left">◄</button>
                <button id="right-btn" class="d-pad-btn right" data-direction="right">►</button>
                <button id="down-btn" class="d-pad-btn down" data-direction="down">▼</button>
                <div class="d-pad-center"></div>
            </div>
            <div class="action-buttons">
                <button id="fire-btn" class="action-btn fire">FIRE</button>
                <button id="turret-btn" class="action-btn turret">TURRET</button>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <p>Score: <span id="score-display">0</span></p>
        <p>Hi-Score: <span id="hi-score-display">0</span></p>
        <p>Enemies Left: <span id="enemies-display">3</span></p>
        <p>Health: <div id="health-bar-container"><div id="health-bar"></div></div></p>
    </div>

    <!-- START: The start menu is now visible by default. -->
    <div id="start-menu">
        <h2>Space Paranoids Labyrinth</h2>
        <p>Use the D-Pad to move and the Fire button to shoot. Hold the Turret button and use the D-Pad to aim your turret.</p>
        <!-- The onclick attribute has been added here to directly call the startGame function -->
        <button id="start-game-btn" class="game-button" onclick="startGame()">Start Game</button>
        <button id="options-btn" class="game-button">Options</button>
    </div>
    <!-- END: The start menu is now visible by default. -->

    <div id="options-menu">
        <h2>Options</h2>
        <p>Controls and settings will be here.</p>
        <button id="back-to-start-btn" class="game-button">Back</button>
    </div>

    <div id="message-box">
        <h2 id="message-title">Game Over</h2>
        <p id="message-text">Your final score is: <span id="final-score">0</span></p>
        <button id="box-restart-button" class="game-button">Play Again</button>
    </div>
    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const hiScoreDisplay = document.getElementById('hi-score-display');
        const enemiesDisplay = document.getElementById('enemies-display');
        const messageBox = document.getElementById('message-box');
        const finalScoreDisplay = document.getElementById('final-score');
        const boxRestartButton = document.getElementById('box-restart-button');
        const healthBar = document.getElementById('health-bar');
        const gameContainer = document.getElementById('game-container');
        const pauseButton = document.getElementById('pause-button');
        
        // New UI Elements
        const startMenu = document.getElementById('start-menu');
        const optionsMenu = document.getElementById('options-menu');
        // The startGameButton element is no longer needed since we are using the onclick attribute in HTML.
        const optionsButton = document.getElementById('options-btn');
        const backToStartButton = document.getElementById('back-to-start-btn');
        const upButton = document.getElementById('up-btn');
        const downButton = document.getElementById('down-btn');
        const leftButton = document.getElementById('left-btn');
        const rightButton = document.getElementById('right-btn');
        const fireButton = document.getElementById('fire-btn');
        const turretButton = document.getElementById('turret-btn');

        let isGameOver = true;
        let isPaused = true;
        let score = 0;
        let highScore = localStorage.getItem('hiScore') || 0;
        let animationFrameId;
        let explosions = [];
        let powerUps = [];
        let lastPowerUpSpawn = 0;
        let isTransitioningLevel = false;
        let levelTimeoutId = null;
        let playerDefaultColor = '#00ffff';
        let playerIsFlashing = false;
        let defaultBorderColor = '#00ffff';
        let defaultBorderShadow = '0 0 20px #00ffff, 0 0 10px #00ffff inset';

        // Maze dimensions
        const MAZE_WIDTH = 13;
        const MAZE_HEIGHT = 13;
        let CELL_SIZE = 40;
        let maze = [];

        function generateMaze() {
            maze = Array(MAZE_HEIGHT).fill(null).map(() => Array(MAZE_WIDTH).fill(1));
            const stack = [];
            const startX = Math.floor(Math.random() * MAZE_WIDTH);
            const startY = Math.floor(Math.random() * MAZE_HEIGHT);
            stack.push({ x: startX, y: startY });
            maze[startY][startX] = 0;
            const directions = [{x: 0, y: 1}, {x: 0, y: -1}, {x: 1, y: 0}, {x: -1, y: 0}];
            while(stack.length > 0) {
                const current = stack[stack.length - 1];
                const neighbors = [];
                directions.forEach(dir => {
                    const nextX = current.x + dir.x * 2;
                    const nextY = current.y + dir.y * 2;
                    if (nextX >= 0 && nextX < MAZE_WIDTH && nextY >= 0 && nextY < MAZE_HEIGHT && maze[nextY][nextX] === 1) {
                        neighbors.push({ x: nextX, y: nextY, dir: dir });
                    }
                });
                if (neighbors.length > 0) {
                    const next = neighbors[Math.floor(Math.random() * neighbors.length)];
                    maze[current.y + next.dir.y][current.x + next.dir.x] = 0;
                    maze[next.y][next.x] = 0;
                    stack.push({ x: next.x, y: next.y });
                } else {
                    stack.pop();
                }
            }
        }

        function drawMaze() {
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#00ffff';
            ctx.shadowBlur = 10;
            for (let y = 0; y < MAZE_HEIGHT; y++) {
                for (let x = 0; x < MAZE_WIDTH; x++) {
                    if (maze[y][x] === 1) {
                        ctx.beginPath();
                        ctx.rect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        ctx.stroke();
                    }
                }
            }
            ctx.shadowBlur = 0;
        }

        // Player (Tank)
        const player = {
            x: 0,
            y: 0,
            size: 20,
            baseSpeed: 3,
            currentSpeed: 3,
            baseFireRate: 300,
            currentFireRate: 300,
            health: 100,
            maxHealth: 100,
            color: playerDefaultColor,
            velocity: { x: 0, y: 0 },
            turretAngle: -Math.PI / 2,
            draw: function() {
                ctx.fillStyle = this.color;
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                
                ctx.beginPath();
                ctx.rect(this.x, this.y, this.size, this.size);
                ctx.fill();
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(this.x + this.size / 2, this.y + this.size / 2);
                const turretLength = this.size * 1.0;
                const turretX = this.x + this.size / 2 + turretLength * Math.cos(this.turretAngle);
                const turretY = this.y + this.size / 2 + turretLength * Math.sin(this.turretAngle);
                ctx.lineTo(turretX, turretY);
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.shadowBlur = 0;
            },
            update: function() {
                const newX = this.x + this.velocity.x;
                const newY = this.y + this.velocity.y;
                if (!checkWallCollision(newX, newY, this.size)) {
                    this.x = newX;
                    this.y = newY;
                }
            }
        };

        function updateHealthBar() {
            const healthPercentage = (player.health / player.maxHealth) * 100;
            healthBar.style.width = `${healthPercentage}%`;
            healthBar.style.backgroundColor = healthPercentage > 50 ? '#00ff00' : (healthPercentage > 25 ? '#ffff00' : '#ff0000');
            healthBar.style.boxShadow = `0 0 5px ${healthBar.style.backgroundColor}`;
        }

        class Projectile {
            constructor(x, y, vx, vy, color, target = 'enemy') {
                this.x = x;
                this.y = y;
                this.size = 5;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.target = target;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
            }
        }

        let projectiles = [];
        let enemyProjectiles = [];
        let powerUpSpawnTimer = 0;
        let powerUpSpawnInterval = 5000;

        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.size = 15;
                this.type = type;
                this.color = '';
                this.duration = 5000;
                if (type === 'health') this.color = '#00ff00';
                if (type === 'speed') this.color = '#ffff00';
                if (type === 'fireRate') this.color = '#ff00ff';
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.arc(this.x + this.size / 2, this.y + this.size / 2, this.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        function spawnPowerUp() {
            const powerUpTypes = ['health', 'speed', 'fireRate'];
            const type = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            let placed = false;
            let attempts = 0;
            while(!placed && attempts < 100) {
                const x = Math.floor(Math.random() * MAZE_WIDTH);
                const y = Math.floor(Math.random() * MAZE_HEIGHT);
                if (maze[y][x] === 0) {
                    const powerUp = new PowerUp(
                        x * CELL_SIZE + (CELL_SIZE - 15) / 2,
                        y * CELL_SIZE + (CELL_SIZE - 15) / 2,
                        type
                    );
                    powerUps.push(powerUp);
                    placed = true;
                }
                attempts++;
            }
        }

        class Enemy {
            constructor() {
                this.size = 20;
                this.x = 0;
                this.y = 0;
                this.speed = 2;
                this.color = '#ff9900';
                this.lastShot = Date.now();
                this.fireRate = 2000;
                this.vx = (Math.random() < 0.5 ? 1 : -1) * this.speed;
                this.vy = (Math.random() < 0.5 ? 1 : -1) * this.speed;
            }
            draw() {
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                
                ctx.beginPath();
                ctx.rect(this.x, this.y, this.size, this.size);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(this.x + this.size / 2, this.y + this.size / 2);
                ctx.lineTo(this.x + this.size / 2, this.y + this.size);
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            update() {
                const newX = this.x + this.vx;
                const newY = this.y + this.vy;
                if (checkWallCollision(newX, newY, this.size)) {
                    const directions = [{x: 1, y: 0}, {x: -1, y: 0}, {x: 0, y: 1}, {x: 0, y: -1}];
                